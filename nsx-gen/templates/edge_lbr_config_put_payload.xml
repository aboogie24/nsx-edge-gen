  <loadBalancer>
   <enabled>true</enabled>
   <enableServiceInsertion>false</enableServiceInsertion>
   <accelerationEnabled>false</accelerationEnabled>
   
   {% for pool in routed_components  if pool['name'] != 'opsmgr' %}
   
   <pool>
    <poolId>pool-{{loop.index}}</poolId>
    <name>{{ pool['name']}}-Pool</name>
    <algorithm>round-robin</algorithm>
    <transparent>false</transparent>
    <monitorId>{{ pool['monitor_type']['id']}}</monitorId>
     {% set outer_loop = loop %}
    {% for ip in pool['ips'].split(',') %}
    <member>
       <memberId>member-{{outer_loop.index}}{{loop.index}}</memberId>
       <ipAddress>{{ ip }}</ipAddress>
       <weight>1</weight>
       {% if 'go' in pool['name'] and 'router' in pool['name'] %}
       <monitorPort>8080</monitorPort>
       {% elif 'tcp' in pool['name'] and 'router' in pool['name'] %}
       <monitorPort>80</monitorPort>
       {% else %}
       <monitorPort>{{ pool['transport']['forward_scheme']['port'] }}</monitorPort>
       {% endif %}
       <port>{{ pool['transport']['forward_scheme']['port'] }}</port>
       <maxConn>0</maxConn>
       <minConn>0</minConn>
       <condition>enabled</condition>
       <name>{{ pool['name']}}-member-{{outer_loop.index}}{{loop.index}}</name>
    </member>
    {% endfor %}
   </pool> 
   {% endfor %}   

   {% for appProfile in appProfile_Map.values() %}
   <applicationProfile>
      <applicationProfileId>{{ appProfile['id'] }}</applicationProfileId>
      <name>{{ appProfile['name'] }}</name>
      <insertXForwardedFor>true</insertXForwardedFor>
      <sslPassthrough>{{ appProfile['sslPassthrough'] }}</sslPassthrough>
      <template>{{ appProfile['template'] }}</template>
      {% if 'HTTPS' in appProfile['name'] or 'TCPS' in appProfile['name'] %}
        <clientSsl>
            <ciphers>DEFAULT</ciphers>
            <clientAuth>ignore</clientAuth>
            <serviceCertificate>{{ nsx_edge['cert_id'] }}</serviceCertificate>
        </clientSsl>
      {% endif %}
      <serverSslEnabled>{{ appProfile['serverSslEnabled'] }}</serverSslEnabled>
   </applicationProfile>
   {% endfor %}
   {% for monitor in monitor_Map.values() %}           
   <monitor>
      <monitorId>{{monitor['id']}}</monitorId>
      <type>{{monitor['type']}}</type>
      <interval>5</interval>
      <timeout>15</timeout>
      <maxRetries>3</maxRetries>
      {% if monitor['type'] != 'tcp' %}
        <method>GET</method>
        <url>{{monitor['url']}}</url>
      {% endif %}
      <name>{{monitor['name']}}</name>
   </monitor>
   {% endfor %}
   {% for name, appRule in appRule_Map.iteritems() %}
   <applicationRule>
        <applicationRuleId>{{ appRule['id'] }}</applicationRuleId>
        <name>{{ name }}</name>
        <script>{{ appRule['script']  }}</script>
    </applicationRule>
   {% endfor %}
   {% for virtServer in routed_components if virtServer['name'] != 'opsmgr'%}
   
   <virtualServer>
    <virtualServerId>virtualServer-{{loop.index}}</virtualServerId>
    <name>VIP-{{virtServer['name']}}-{{virtServer['transport']['incoming_scheme']['protocol']}}</name>
    <enabled>true</enabled>
    <ipAddress>{{virtServer['uplink_details']['uplink_ip']}}</ipAddress>
    <protocol>{{virtServer['transport']['incoming_scheme']['protocol']}}</protocol>
    <port>{{virtServer['transport']['incoming_scheme']['port']}}</port>
    <connectionLimit>0</connectionLimit>
    <connectionRateLimit>0</connectionRateLimit>
    <defaultPoolId>pool-{{loop.index}}</defaultPoolId>
    <applicationProfileId>{{virtServer['appProfile']['id']}}</applicationProfileId>
    <enableServiceInsertion>false</enableServiceInsertion>
    <accelerationEnabled>false</accelerationEnabled>
    <applicationRuleId>applicationRule-1</applicationRuleId>
    <applicationRuleId>applicationRule-2</applicationRuleId>
    {% if virtServer['app_rule'] %}
      <applicationRuleId>{{ virtServer['app_rule'] }}</applicationRuleId>
    {% endif %}
   </virtualServer>
   {% endfor %}

   <logging>
      <enable>true</enable>
      <logLevel>info</logLevel>
   </logging>
</loadBalancer>