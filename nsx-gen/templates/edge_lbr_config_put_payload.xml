  <loadBalancer>
   <enabled>true</enabled>
   <enableServiceInsertion>false</enableServiceInsertion>
   <accelerationEnabled>false</accelerationEnabled>
   
   {% for pool in routed_components  if pool['useVIP'] == True %}
   
   <pool>
    <poolId>pool-{{loop.index}}</poolId>
    <name>{{ pool['name']}}-Pool</name>
    <algorithm>round-robin</algorithm>
    <transparent>false</transparent>
    <monitorId>{{ pool['monitor_id']}}</monitorId>
     {% set outer_loop = loop %}    
     {% for ip in pool['ips'].split(',') %}
     {% set middle_loop = loop %} 
     {% for port in pool['transport']['egress']['port'].split(',') %}
    <member>
       <memberId>member-{{outer_loop.index}}{{middle_loop.index}}{{loop.index}}</memberId>
       <ipAddress>{{ ip }}</ipAddress>
       <weight>1</weight>
       {% if pool['transport']['egress']['monitor_port'] %}
       <monitorPort>{{ pool['transport']['egress']['monitor_port'] }}</monitorPort>
       {% else %}
       <monitorPort>{{ port }}</monitorPort>
       {% endif %}
       <port>{{ port }}</port>
       <maxConn>0</maxConn>
       <minConn>0</minConn>
       <condition>enabled</condition>
       <name>{{ pool['name']}}-member-{{outer_loop.index}}{{middle_loop.index}}{{loop.index}}</name>
    </member>
    {% endfor %}
    {% endfor %}
   </pool> 
   {% endfor %}   

   {% for appProfile in appProfileMap.values() %}
   <applicationProfile>
      <applicationProfileId>{{ appProfile['id'] }}</applicationProfileId>
      <name>{{ appProfile['name'] }}</name>
      <insertXForwardedFor>true</insertXForwardedFor>
      <sslPassthrough>{{ appProfile['sslPassthrough'] }}</sslPassthrough>
      <template>{{ appProfile['template'] }}</template>
      {% if 'HTTPS' in appProfile['name'] or 'TCPS' in appProfile['name'] %}
        <clientSsl>
            <ciphers>DEFAULT</ciphers>
            <clientAuth>ignore</clientAuth>
            <serviceCertificate>{{ nsx_edge['cert_id'] }}</serviceCertificate>
        </clientSsl>
      {% endif %}
      <serverSslEnabled>{{ appProfile['serverSslEnabled'] }}</serverSslEnabled>
   </applicationProfile>
   {% endfor %}
   {% for monitor in monitorMap.values() %}           
   <monitor>
      <monitorId>{{monitor['id']}}</monitorId>
      <type>{{monitor['type']}}</type>
      <interval>5</interval>
      <timeout>15</timeout>
      <maxRetries>3</maxRetries>
      {% if monitor['type'] != 'tcp' %}
        <method>GET</method>
        <url>{{monitor['url']}}</url>
      {% endif %}
      <name>{{monitor['name']}}</name>
   </monitor>
   {% endfor %}
   {% for name, appRule in appRuleMap.iteritems() %}
   <applicationRule>
        <applicationRuleId>{{ appRule['id'] }}</applicationRuleId>
        <name>{{ name }}</name>
        <script>{{ appRule['script']  }}</script>
    </applicationRule>
   {% endfor %}
   {% for virtServer in routed_components if virtServer['name'] != 'opsmgr'%}
   
   <virtualServer>
    <virtualServerId>virtualServer-{{loop.index}}</virtualServerId>
    <name>VIP-{{virtServer['name']}}-{{virtServer['transport']['ingress']['protocol']}}</name>
    <enabled>true</enabled>
    <ipAddress>{{virtServer['uplink_details']['uplink_ip']}}</ipAddress>
    <protocol>{{virtServer['transport']['ingress']['protocol']}}</protocol>
    <port>{{virtServer['transport']['ingress']['port']}}</port>
    <connectionLimit>0</connectionLimit>
    <connectionRateLimit>0</connectionRateLimit>
    <defaultPoolId>pool-{{loop.index}}</defaultPoolId>
    <applicationProfileId>{{virtServer['app_profile']['id']}}</applicationProfileId>
    <enableServiceInsertion>false</enableServiceInsertion>
    <accelerationEnabled>false</accelerationEnabled>
    {% for app_rule_id in virtServer['app_rules'] %}
      <applicationRuleId>{{ app_rule_id }}</applicationRuleId>
    {% endfor %}
   </virtualServer>
   {% endfor %}

   <logging>
      <enable>true</enable>
      <logLevel>info</logLevel>
   </logging>
</loadBalancer>